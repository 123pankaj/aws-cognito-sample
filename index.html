<html>
    <head>
        <title>Test Page for Cognito</title>

        <script src="js/jsbn.js"></script>
        <script src="js/jsbn2.js"></script>
        <script src="js/sjcl.js"></script>
        <script src="js/moment.js"></script>
        <script src="js/aws-cognito-sdk.min.js"></script>
        <script src="js/amazon-cognito-identity.min.js"></script>
        <script src="js/aws-sdk.js"></script>
        <script src="bootstrap-3.3.7-dist/js/bootstrap.js"></script>
        <script src="bootstrap-3.3.7-dist/js/npm.js"></script>
        <link rel="stylesheet" href="bootstrap-3.3.7-dist/css/bootstrap.css"/>

        <script type="text/javascript">
            var cognitoUser;

            <!-- UI Related Function -->
            function showMenuDiv (display) {
                var e = document.getElementById('menuDiv');
                if (display)
                    e.style.display = 'block';
                else
                    e.style.display = 'none';
            }

            function showLoginDiv (display) {
                var e = document.getElementById('loginDiv');
                if (display)
                    e.style.display = 'block';
                else
                    e.style.display = 'none';
            }

            function setLoginErrorMessge (err) {
                var errorFld = document.getElementById ('loginErrMsg');
                errorFld.innerHTML = err.message;
            }


            function clearLoginError () {
                var errorFld = document.getElementById ('loginErrMsg');
                errorFld.innerHTML = '&nbsp;';
            }


            function disableButton (buttonName) {
                var aButton = document.getElementById (buttonName);
                aButton.disabled=true;
                aButton.innerHTML = "<img src='images/loading.gif'/>";
            }


            function enableButton (buttonName, buttonText) {
                var aButton = document.getElementById (buttonName);
                aButton.disabled=false;
                aButton.innerHTML = buttonText;
            }



            function _makeAWSCredentials (idToken) {
                return new AWS.CognitoIdentityCredentials( {
                    IdentityPoolId: 'us-west-2:b23326a5-e847-49ff-aa97-f4167056c634',
                    Logins: {
                       'cognito-idp.us-west-2.amazonaws.com/us-west-2_9M8H5S4iM': idToken
                    }
                });
            }


            function _makeUserPool () {
                var poolData = {
                    UserPoolId : 'us-west-2_9M8H5S4iM',
                    ClientId : '1mqi4tjdhr4f737pbbimolhhut'
                };
                return new AWSCognito.CognitoIdentityServiceProvider.CognitoUserPool(poolData);
            }



            function init () {
                AWS.config.region = 'us-west-2';


                // Load cognito User from local storage
                var userPool = _makeUserPool ();
                cognitoUser = userPool.getCurrentUser();


                // If not Found, show login page
                if (cognitoUser == null) {
                    showLoginDiv (true);
                    showMenuDiv(false);
                    return;
                }


                // Load Session from Local storage if found
                cognitoUser.getSession(function(err, session) {
                    if (err) {
                        alert(err);
                        return;
                    }

                    console.log('session validity: ' + session.isValid());
                    console.log('ID Token: ' + session.idToken.jwtToken);

                    // Set Credentials within AWS Config to access other AWS services
                    var idToken = session.idToken.jwtToken;
                    AWS.config.credentials = _makeAWSCredentials (idToken);

                    // Refresh the credentials - in case the session has expired
                    AWS.config.credentials.get(function(err){
                        if (err) {
                            alert(err);
                        }
                    });

                });

                // if user is logged IN, show Menu
                showMenuDiv (true);
                showLoginDiv (false);
            }



            function onLogin () {
                clearLoginError ();
                disableButton ('loginButton');

                var userNameFld = document.getElementById ('userName');
                var passwordFld = document.getElementById ('password');

                if (userNameFld === null || passwordFld === null) {
                    alert ('Programmatic Error. User Name or Password Field is not configured properly');
                    return;
                }

                var userName = userNameFld.value;
                var password = passwordFld.value;

                // Now Login to AWS
                _loginToAWS (userName, password);
            }



            function _loginToAWS (userName, password) {
                var userPool = _makeUserPool ();
                var userData = {
                    Username : userName,
                    Pool : userPool
                };
                cognitoUser = new AWSCognito.CognitoIdentityServiceProvider.CognitoUser(userData);

                var authenticationData = {
                        Username : userName,
                        Password : password,
                    };
                var authenticationDetails = new AWSCognito.CognitoIdentityServiceProvider.AuthenticationDetails(authenticationData);


                cognitoUser.authenticateUser(authenticationDetails, {
                    onSuccess: _callbackOnAWSLoginSuccess,
                    onFailure: _callbackOnAWSLoginFailure,
                    newPasswordRequired: _callbackOnAWSForcePasswdChange
                });

            }


            function _callbackOnAWSLoginSuccess (result) {
                console.log('access token + ' + result.getAccessToken().getJwtToken());
                /*Use the idToken for Logins Map when Federating User Pools with Cognito Identity or when passing through an Authorization Header to an API Gateway Authorizer*/
                console.log('idToken + ' + result.idToken.jwtToken);

                idToken = result.idToken.jwtToken;
                AWS.config.credentials = new AWS.CognitoIdentityCredentials( {
                    IdentityPoolId: 'us-west-2:b23326a5-e847-49ff-aa97-f4167056c634',
                    Logins: {
                       'cognito-idp.us-west-2.amazonaws.com/us-west-2_9M8H5S4iM': idToken
                    }
                });

                setTimeout (function () {
                    enableButton ('loginButton', 'Sign in');
                    showMenuDiv (true);
                    showLoginDiv (false);
                }, 100);
            }



            function _callbackOnAWSLoginFailure (err) {
                console.log ("Failure: ");
                setLoginErrorMessge (err);
                enableButton ('loginButton', 'Sign in');
            }



            // TODO: Improve this by asking for modified password
            function _callbackOnAWSForcePasswdChange (userAttributes, requiredAttributes) {
                // User was signed up by an admin and must provide new
                // password and required attributes, if any, to complete
                // authentication.

                // userAttributes: object, which is the user's current profile. It will list all attributes that are associated with the user.
                // Required attributes according to schema, which donâ€™t have any values yet, will have blank values.
                // requiredAttributes: list of attributes that must be set by the user along with new password to complete the sign-in.

                console.log('User Attributes: ' + userAttributes);
                console.log('Required Attributes: ' + requiredAttributes);

                // Get these details and call
                // newPassword: password that user has given
                // attributesData: object with key as attribute name and value that the user has given.
                cognitoUser.completeNewPasswordChallenge('password123', {}, this)
            }




            function onLogout () {
                if (cognitoUser == null) {
                    alert ('user not logged in');
                    return;
                }

                cognitoUser.signOut ();
                cognitoUser = null;
                showLoginDiv (true);
                showMenuDiv (false);
                console.log ('Signed Out');
            }


            function showS3BucketContents () {
                disableButton ('viewS3BucketButton')
                var bucketNameFld = document.getElementById ('s3BucketName');
                var bucketName = bucketNameFld.value;


                var bucket = new AWS.S3({
                    params: {
                        Bucket: bucketName
                    }
                });

                var params = {
                  Bucket: bucketName, /* required */
                  Key: 'some-dummy-data', /* required */
                  Body: 'random-stuff'
                };

                bucket.listObjects({}, function (err, data) {
                    var textToDisplay = "";

                    if (err) {
                        textToDisplay = 'ERROR: ' + err;
                    } else {
                        var count = 0;
                        data.Contents.forEach(function (obj) {
                            textToDisplay += "- " + obj.Key + "\n";
                            count++;
                            if (count >=10) {
                                return;
                            }
                        });
                    }

                    enableButton ('viewS3BucketButton', 'View Contents')
                    alert ("Files in S3 Bucket (upto 10 only) \n\n" + textToDisplay);
                });
            }


            function uploadToS3() {
                AWS.config.region = 'us-west-2';
                AWS.config.credentials = new AWS.CognitoIdentityCredentials({
                   IdentityPoolId: 'us-west-2:b23326a5-e847-49ff-aa97-f4167056c634',
                   Logins: {
                      'cognito-idp.us-west-2.amazonaws.com/us-west-2_9M8H5S4iM': idToken
                   }
                });


                AWS.config.credentials.get(function(err){
                    if (err) {
                        alert(err);
                    }
                });

                var bucketName = 'guneetapp';
                var bucket = new AWS.S3({
                    params: {
                        Bucket: bucketName
                    }
                });


                var files = document.getElementById('photoupload').files;
                if (!files.length) {
                    return alert('Please choose a file to upload first.');
                }
                var file = files[0];

                var params = {
                    Bucket: bucketName, /* required */
                    Key: 'some-random-photo',
                    Body: file,
                    ACL: 'public-read'
                };

                bucket.upload (params, function (err, data) {
                    if (err)
                        console.log (err, err.stack);
                    else
                        console.log (data);
                });
            }

        </script>
    </head>

    <body onload="init()">

        <!-- Div Showing Login Page -->
        <div class="container" style="display:none" id="loginDiv">
            <h3>Please Login to Proceed Further</h3>
            <label style="color:red" id="loginErrMsg">&nbsp;</label>

            <div class="form-inline">
                <div class="form-group">
                    <label class="sr-only" for="exampleInputEmail3">Email address</label>
                    <input class="form-control" id="userName" placeholder="UserName">
                </div>
                <div class="form-group">
                    <label class="sr-only" for="exampleInputPassword3">Password</label>
                    <input type="password" class="form-control" id="password" placeholder="Password">
                </div>
                <button class="btn btn-default" onclick="onLogin ()" id="loginButton">Sign in</button>
            </div>
        </div>

        <!-- Div Showing the Post Login Menu -->
        <div class="container" style="display:none" id="menuDiv">

            <h3>Welcome !!!! </h3>

            <div class="row">
                <div class="col-md-12"><h5>S3</h5></div>
            </div>
            <div class="row">
                <div class="col-md-3"><input type="text" class="form-control" id="s3BucketName" placeholder="S3Bucket Name" /></div>
                <div class="col-md-3"><button class="btn btn-default" onclick="showS3BucketContents ()" id="viewS3BucketButton">View Contents</button></div>
            </div>

            <div class="row">
                <div class="col-md-6">&nbsp;</div>
            </div>

            <div class="row">
                <div class="col-md-6" style="text-align:center"><button type="button" class="btn btn-danger" onclick="onLogout()">Logout</button></div>
            </div>
    </body>
<!--
    <body onload="init(); loadUserFromLocalStorage ();">
        <label>UserName: </label><input type="text" id="userName"> <br/>
        <label>Password: </label><input type="password" id="password"> <br/>
        <button onclick="onLogin ()">Login</button>

        <p>
            S3 Bucket: <button onclick="playWithS3()">Play With S3</button>
        </p>
        <div id="results"></div>

        <input id="photoupload" type="file" accept="image/*"> <button onclick="uploadToS3()">Upload</button>

        <p>
            Logout: <button onclick="onLogout()">Logout</button>
        </p>
    </body>
-->
</html>
